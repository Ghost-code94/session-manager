syntax = "proto3";

package grpc.ghostcache;
option java_package       = "grpc.ghostcache";
option java_multiple_files = true;

// ─── Cache (unchanged) ────────────────────────────────────────────────────
service CacheService {
  rpc Get(GetRequest)               returns (GetReply);
  rpc Put(PutRequest)               returns (PutReply);
  rpc Invalidate(InvalidateRequest) returns (InvalidateReply);
  rpc ListKeys(Empty)               returns (stream KeyEntry);

  // Versioning
  rpc GetVersioned(VersionedGetRequest) returns (GetReply);
  rpc History(GetRequest)               returns (HistoryReply);
  rpc Rollback(VersionedGetRequest)     returns (PutReply);
}

// ─── NEW  Session service ─────────────────────────────────────────────────
service SessionService {
  rpc CreateSession(CreateSessionRequest) returns (CreateSessionReply);
  rpc GetSession   (GetSessionRequest)    returns (GetSessionReply);
  rpc DeleteSession(DeleteSessionRequest) returns (DeleteSessionReply);
  rpc PutSession   (PutSessionRequest)    returns (PutSessionReply);
}

// ─── Common messages (cache) ──────────────────────────────────────────────
message Empty {}

message GetRequest         { string key  = 1; }
message GetReply           { bool found  = 1; bytes value = 2; }
message PutRequest         { string key  = 1; bytes value = 2; int32 ttlSec = 3; }
message PutReply           { bool ok     = 1; }
message InvalidateRequest  { string key  = 1; }
message InvalidateReply    { bool ok     = 1; }
message KeyEntry           { string key  = 1; }

message VersionedGetRequest { string key = 1; string version = 2; }
message HistoryEntry        { string version = 1; int64 timestamp = 2; }
message HistoryReply        { repeated HistoryEntry versions = 1; }

// ─── Session messages ─────────────────────────────────────────────────────
message CreateSessionRequest { string user_id = 1; int32 ttlSec = 2; } // default ttl set server-side
message CreateSessionReply   { string session_id = 1; }

message GetSessionRequest    { string session_id = 1; }
message GetSessionReply      { bool valid = 1; bytes payload = 2; }

message DeleteSessionRequest { string session_id = 1; }
message DeleteSessionReply   { bool ok = 1; }

message PutSessionRequest  {
  string session_id = 1;   // the ID from the cookie
  int32  ttlSec     = 2;   // renew TTL; 0 = use default
  bytes  payload    = 3;   // opaque blob
}

message PutSessionReply    { bool ok = 1; }
